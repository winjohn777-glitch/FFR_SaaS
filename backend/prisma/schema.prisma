generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id            String          @id @default(cuid())
  name          String
  address       String?
  phone         String?
  email         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  accounts      Account[]
  bills         Bill[]
  customers     Customer[]
  employees     Employee[]
  inventory     InventoryItem[]
  invoices      Invoice[]
  projects      Project[]
  users         User[]
  journalEntries JournalEntry[]
  fiscalPeriods FiscalPeriod[]
  contacts      Contact[]

  @@map("organizations")
}

model User {
  id                     String         @id @default(cuid())
  email                  String         @unique
  passwordHash           String
  firstName              String
  lastName               String
  role                   UserRole       @default(USER)
  isActive               Boolean        @default(true)
  lastLogin              DateTime?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  organizationId         String
  bills                  Bill[]
  invoices               Invoice[]
  journalEntriesCreated  JournalEntry[] @relation("JournalEntryCreatedBy")
  journalEntriesApproved JournalEntry[] @relation("JournalEntryApprovedBy")
  journalEntriesPosted   JournalEntry[] @relation("JournalEntryPostedBy")
  payments               Payment[]
  organization           Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Account {
  id                String             @id @default(cuid())
  code              String             @unique
  name              String
  type              AccountType
  category          String
  description       String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  organizationId    String
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  journalEntryLines JournalEntryLine[]

  @@map("accounts")
}

model JournalEntry {
  id                   String               @id @default(cuid())
  number               String               @unique
  date                 DateTime
  description          String
  reference            String?
  status               JournalEntryStatus   @default(DRAFT)
  isPosted             Boolean              @default(false)
  sourceModule         SourceModule         @default(MANUAL)
  quickEntryTemplate   String?
  totalDebit           Decimal              @default(0) @db.Decimal(12, 2)
  totalCredit          Decimal              @default(0) @db.Decimal(12, 2)
  notes                String?
  reversedByEntryId    String?              @unique // ID of reversing entry
  originalEntryId      String?              @unique // ID of original entry being reversed
  isReversing          Boolean              @default(false)
  isRecurring          Boolean              @default(false)
  recurringFrequency   RecurringFrequency?
  recurringEndDate     DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  approvedAt           DateTime?
  postedAt             DateTime?
  organizationId       String
  fiscalPeriodId       String
  createdById          String
  approvedByUserId     String?
  postedByUserId       String?
  lines                JournalEntryLine[]
  organization         Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fiscalPeriod         FiscalPeriod         @relation(fields: [fiscalPeriodId], references: [id])
  createdBy            User                 @relation("JournalEntryCreatedBy", fields: [createdById], references: [id])
  approvedBy           User?                @relation("JournalEntryApprovedBy", fields: [approvedByUserId], references: [id])
  postedBy             User?                @relation("JournalEntryPostedBy", fields: [postedByUserId], references: [id])
  reversedByEntry      JournalEntry?        @relation("ReversedBy", fields: [reversedByEntryId], references: [id])
  originalEntry        JournalEntry?        @relation("OriginalEntry", fields: [originalEntryId], references: [id])
  reversalEntries      JournalEntry[]       @relation("ReversedBy")
  reversedEntries      JournalEntry[]       @relation("OriginalEntry")

  @@index([organizationId, date])
  @@index([organizationId, status])
  @@index([organizationId, fiscalPeriodId])
  @@index([sourceModule])
  @@map("journal_entries")
}

model JournalEntryLine {
  id             String        @id @default(cuid())
  debit          Decimal       @default(0) @db.Decimal(12, 2)
  credit         Decimal       @default(0) @db.Decimal(12, 2)
  memo           String?
  reference      String?       // Additional reference for tracking
  lineNumber     Int           // Order of lines within entry
  journalEntryId String
  accountId      String
  contactId      String?       // For vendor/customer tracking
  projectId      String?       // For job costing
  account        Account       @relation(fields: [accountId], references: [id])
  journalEntry   JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  contact        Contact?      @relation(fields: [contactId], references: [id])
  project        Project?      @relation(fields: [projectId], references: [id])

  @@index([journalEntryId, lineNumber])
  @@index([accountId])
  @@map("journal_entry_lines")
}

model Customer {
  id             String        @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  city           String?
  state          String?
  zip            String?
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices       Invoice[]
  leads          Lead[]
  opportunities  Opportunity[]
  projects       Project[]

  @@map("customers")
}

model Lead {
  id            String        @id @default(cuid())
  source        String
  status        LeadStatus    @default(NEW)
  notes         String?
  value         Decimal?      @db.Decimal(10, 2)
  probability   Int?          @default(50)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  customerId    String
  customer      Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  opportunities Opportunity[]

  @@map("leads")
}

model Opportunity {
  id           String            @id @default(cuid())
  title        String
  description  String?
  status       OpportunityStatus @default(PROSPECTING)
  value        Decimal           @db.Decimal(10, 2)
  probability  Int               @default(50)
  expectedDate DateTime?
  closedDate   DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  customerId   String
  leadId       String?
  customer     Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  lead         Lead?             @relation(fields: [leadId], references: [id])
  projects     Project[]

  @@map("opportunities")
}

model Project {
  id                String             @id @default(cuid())
  name              String
  description       String?
  status            ProjectStatus      @default(PLANNING)
  startDate         DateTime?
  endDate           DateTime?
  budget            Decimal?           @db.Decimal(10, 2)
  actualCost        Decimal            @default(0) @db.Decimal(10, 2)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  organizationId    String
  customerId        String
  opportunityId     String?
  invoices          Invoice[]
  tasks             ProjectTask[]
  journalEntryLines JournalEntryLine[]
  customer          Customer           @relation(fields: [customerId], references: [id])
  opportunity       Opportunity?       @relation(fields: [opportunityId], references: [id])
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("projects")
}

model ProjectTask {
  id             String            @id @default(cuid())
  title          String
  description    String?
  status         ProjectTaskStatus @default(TODO)
  startDate      DateTime?
  endDate        DateTime?
  estimatedHours Int?
  actualHours    Int?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  projectId      String
  project        Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_tasks")
}

model InventoryItem {
  id             String        @id @default(cuid())
  name           String
  description    String?
  sku            String        @unique
  category       String?
  unit           String
  cost           Decimal       @db.Decimal(10, 2)
  price          Decimal       @db.Decimal(10, 2)
  quantity       Int           @default(0)
  minQuantity    Int           @default(0)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String
  billItems      BillItem[]
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoiceItems   InvoiceItem[]

  @@map("inventory_items")
}

model Invoice {
  id             String        @id @default(cuid())
  number         String        @unique
  date           DateTime
  dueDate        DateTime
  status         InvoiceStatus @default(DRAFT)
  subtotal       Decimal       @db.Decimal(10, 2)
  tax            Decimal       @default(0) @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String
  customerId     String
  projectId      String?
  createdById    String
  items          InvoiceItem[]
  createdBy      User          @relation(fields: [createdById], references: [id])
  customer       Customer      @relation(fields: [customerId], references: [id])
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project        Project?      @relation(fields: [projectId], references: [id])
  payments       Payment[]

  @@map("invoices")
}

model InvoiceItem {
  id              String         @id @default(cuid())
  description     String
  quantity        Int
  unitPrice       Decimal        @db.Decimal(10, 2)
  total           Decimal        @db.Decimal(10, 2)
  invoiceId       String
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])
  invoice         Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model Bill {
  id             String       @id @default(cuid())
  number         String
  vendorName     String
  date           DateTime
  dueDate        DateTime
  status         BillStatus   @default(PENDING)
  subtotal       Decimal      @db.Decimal(10, 2)
  tax            Decimal      @default(0) @db.Decimal(10, 2)
  total          Decimal      @db.Decimal(10, 2)
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  createdById    String
  items          BillItem[]
  createdBy      User         @relation(fields: [createdById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payments       Payment[]

  @@map("bills")
}

model BillItem {
  id              String         @id @default(cuid())
  description     String
  quantity        Int
  unitPrice       Decimal        @db.Decimal(10, 2)
  total           Decimal        @db.Decimal(10, 2)
  billId          String
  inventoryItemId String?
  bill            Bill           @relation(fields: [billId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  @@map("bill_items")
}

model Payment {
  id          String        @id @default(cuid())
  amount      Decimal       @db.Decimal(10, 2)
  date        DateTime
  method      PaymentMethod
  reference   String?
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdById String
  invoiceId   String?
  billId      String?
  bill        Bill?         @relation(fields: [billId], references: [id])
  createdBy   User          @relation(fields: [createdById], references: [id])
  invoice     Invoice?      @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

enum UserRole {
  ADMIN
  MANAGER
  ACCOUNTANT
  USER
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}

enum OpportunityStatus {
  PROSPECTING
  QUALIFICATION
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectTaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

enum BillStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CHECK
  CREDIT_CARD
  BANK_TRANSFER
  ACH
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

enum CertificationStatus {
  VALID
  EXPIRING
  EXPIRED
}

model Employee {
  id             String            @id @default(cuid())
  employeeId     String            @unique
  firstName      String
  lastName       String
  role           String
  department     String
  email          String            @unique
  phone          String?
  address        String?
  hireDate       DateTime
  status         EmployeeStatus    @default(ACTIVE)
  payRate        Float
  hoursThisWeek  Float             @default(0)
  overtime       Float             @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  certifications Certification[]

  @@map("employees")
}

model Certification {
  id                String              @id @default(cuid())
  name              String
  type              String
  issueDate         DateTime
  expirationDate    DateTime
  status            CertificationStatus
  certificateNumber String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  employeeId        String
  employee          Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("certifications")
}

model FiscalPeriod {
  id             String         @id @default(cuid())
  name           String         // e.g., "January 2024", "Q1 2024", "FY 2024"
  type           PeriodType     // MONTH, QUARTER, YEAR
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean        @default(true)
  isClosed       Boolean        @default(false)
  closedAt       DateTime?
  closedById     String?
  year           Int
  period         Int            // 1-12 for months, 1-4 for quarters, 1 for year
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  journalEntries JournalEntry[]

  @@unique([organizationId, type, year, period])
  @@index([organizationId, isActive])
  @@index([organizationId, isClosed])
  @@map("fiscal_periods")
}

model Contact {
  id                String             @id @default(cuid())
  name              String
  type              ContactType        @default(OTHER)
  email             String?
  phone             String?
  address           String?
  city              String?
  state             String?
  zip               String?
  taxId             String?            // Tax ID for vendors
  isActive          Boolean            @default(true)
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  organizationId    String
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  journalEntryLines JournalEntryLine[]

  @@index([organizationId, type])
  @@index([name])
  @@map("contacts")
}

enum JournalEntryStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  POSTED
  REJECTED
  CANCELLED
}

enum SourceModule {
  MANUAL
  ACCOUNTS_PAYABLE
  ACCOUNTS_RECEIVABLE
  PAYROLL
  INVENTORY
  BANK_RECONCILIATION
  DEPRECIATION
  ACCRUALS
  ADJUSTMENTS
  YEAR_END
  INTEGRATION
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
}

enum PeriodType {
  MONTH
  QUARTER
  YEAR
}

enum ContactType {
  CUSTOMER
  VENDOR
  EMPLOYEE
  OTHER
}

// ============================================
// SOP SYSTEM MODELS
// ============================================

model SopCategory {
  id          String         @id @default(cuid())
  code        String         @unique // e.g., "0000", "1000", "2000"
  name        String
  description String?
  parentId    String?
  isActive    Boolean        @default(true)
  sortOrder   Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  parent      SopCategory?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    SopCategory[]  @relation("CategoryHierarchy")
  procedures  SopProcedure[]

  @@index([code])
  @@index([parentId])
  @@map("sop_categories")
}

model SopProcedure {
  id                  String                    @id @default(cuid())
  sopNumber           String                    @unique // e.g., "1000-A-001"
  title               String
  description         String?
  version             String                    @default("1.0")
  status              SopStatus                 @default(DRAFT)
  priority            SopPriority               @default(MEDIUM)
  categoryId          String
  contentFilePath     String?
  effectiveDate       DateTime?
  reviewDate          DateTime?
  approvedById        String?
  isActive            Boolean                   @default(true)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  category            SopCategory               @relation(fields: [categoryId], references: [id])
  forms               SopForm[]
  assignments         SopAssignment[]
  compliance          SopCompliance[]
  workflows           SopWorkflow[]
  trainingRequirements SopTrainingRequirement[]
  performanceMetrics  SopPerformanceMetric[]

  @@index([categoryId])
  @@index([status])
  @@index([sopNumber])
  @@map("sop_procedures")
}

model SopForm {
  id          String       @id @default(cuid())
  formNumber  String       @unique
  title       String
  description String?
  formType    String       // checklist, inspection, report
  template    String?      // JSON template structure
  procedureId String
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  procedure   SopProcedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  @@index([procedureId])
  @@map("sop_forms")
}

model SopManual {
  id          String   @id @default(cuid())
  manualCode  String   @unique
  title       String
  description String?
  version     String   @default("1.0")
  filePath    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("sop_manuals")
}

model SopAssignment {
  id           String       @id @default(cuid())
  procedureId  String
  employeeId   String?
  projectId    String?
  dueDate      DateTime?
  status       String       @default("pending") // pending, in_progress, completed
  assignedById String?
  completedAt  DateTime?
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  procedure    SopProcedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  @@index([procedureId])
  @@index([employeeId])
  @@index([projectId])
  @@map("sop_assignments")
}

model SopCompliance {
  id              String       @id @default(cuid())
  procedureId     String
  employeeId      String?
  projectId       String?
  complianceDate  DateTime
  status          String       @default("compliant") // compliant, non_compliant, pending
  verifiedById    String?
  notes           String?
  evidence        String?      // JSON: file references
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  procedure       SopProcedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  @@index([procedureId])
  @@index([status])
  @@map("sop_compliance")
}

model SopWorkflow {
  id           String                 @id @default(cuid())
  workflowId   String                 @unique
  procedureId  String
  leadId       String?
  customerId   String?
  projectId    String?
  triggerType  String                 // lead_integration, manual, scheduled
  status       WorkflowStatus         @default(ACTIVE)
  urgency      String                 @default("medium")
  serviceType  String?
  assignedTo   String?
  startedAt    DateTime?
  completedAt  DateTime?
  metadata     String?                // JSON
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  procedure    SopProcedure           @relation(fields: [procedureId], references: [id])
  tasks        SopWorkflowTask[]
  executions   SopWorkflowExecution[]

  @@index([procedureId])
  @@index([status])
  @@index([workflowId])
  @@map("sop_workflows")
}

model SopWorkflowTask {
  id              String      @id @default(cuid())
  workflowId      String
  title           String
  description     String?
  sequenceNumber  Int
  status          String      @default("pending") // pending, in_progress, completed, skipped, failed
  priority        String      @default("medium")
  assignedTo      String?
  dueDate         DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  completionNotes String?
  metadata        String?     // JSON
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  workflow        SopWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@map("sop_workflow_tasks")
}

model SopWorkflowExecution {
  id              String      @id @default(cuid())
  workflowId      String
  executionNumber Int
  status          String      @default("running") // running, completed, failed, cancelled
  startedAt       DateTime    @default(now())
  completedAt     DateTime?
  result          String?     // JSON: execution results
  errorMessage    String?
  createdAt       DateTime    @default(now())
  workflow        SopWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@map("sop_workflow_executions")
}

model SopTrainingRequirement {
  id                  String       @id @default(cuid())
  procedureId         String
  roleRequired        String?      // Role that requires this training
  departmentRequired  String?
  frequencyDays       Int?         // How often retraining needed
  isMandatory         Boolean      @default(false)
  description         String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  procedure           SopProcedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  @@index([procedureId])
  @@map("sop_training_requirements")
}

model SopPerformanceMetric {
  id              String       @id @default(cuid())
  procedureId     String
  metricDate      DateTime
  executionCount  Int          @default(0)
  completionRate  Float?
  avgCompletionTime Int?       // in minutes
  complianceRate  Float?
  createdAt       DateTime     @default(now())
  procedure       SopProcedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  @@index([procedureId])
  @@index([metricDate])
  @@map("sop_performance_metrics")
}

model SopMobileSync {
  id            String   @id @default(cuid())
  deviceId      String
  userId        String
  lastSyncAt    DateTime
  syncStatus    String   @default("completed") // completed, pending, failed
  syncedItems   String?  // JSON: list of synced procedure IDs
  pendingChanges String? // JSON: offline changes to sync
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([deviceId, userId])
  @@index([userId])
  @@map("sop_mobile_sync")
}

// ============================================
// FLORIDA COMPLIANCE MODELS
// ============================================

model HurricaneProcedure {
  id                String   @id @default(cuid())
  procedureCode     String   @unique
  title             String
  category          String   // pre_storm, during_storm, post_storm, recovery
  priority          Int      @default(0)
  description       String?
  steps             String?  // JSON: procedure steps
  requiredEquipment String?  // JSON: equipment list
  safetyNotes       String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([category])
  @@map("hurricane_procedures")
}

model HvhzComplianceProcedure {
  id                  String   @id @default(cuid())
  procedureCode       String   @unique
  title               String
  windZone            String   // HVHZ, wind_borne_debris, etc.
  countyApplicable    String?  // JSON: list of counties
  description         String?
  requirements        String?  // JSON: specific requirements
  inspectionCriteria  String?  // JSON: inspection points
  documentationNeeded String?  // JSON: required docs
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([windZone])
  @@map("hvhz_compliance_procedures")
}

model CountyRequirement {
  id                  String   @id @default(cuid())
  county              String   @unique
  permitRequired      Boolean  @default(true)
  permitOfficeName    String?
  permitOfficePhone   String?
  permitOfficeAddress String?
  permitFeesRange     String?  // e.g., "$150-$500"
  inspectionProcess   String?  // JSON: inspection steps
  hvhzZone            Boolean  @default(false)
  specialRequirements String?  // JSON: county-specific rules
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("county_requirements")
}

// ============================================
// CRM/MARKETING MODELS
// ============================================

model LeadAssignment {
  id                  String   @id @default(cuid())
  leadId              String
  customerId          String?
  projectId           String?
  salesRep            String?
  projectManager      String?
  estimator           String?
  assignmentDate      DateTime
  assignmentRules     String?  // JSON: rules used for assignment
  reassignmentHistory String?  // JSON: history of reassignments
  status              String   @default("active") // active, completed, reassigned
  createdAt           DateTime @default(now())

  @@index([leadId])
  @@index([customerId])
  @@map("lead_assignments")
}

model LeadAnalytics {
  id                    String    @id @default(cuid())
  leadId                String
  customerId            String?
  projectId             String?
  leadSource            String
  serviceType           String
  county                String
  urgency               String
  estimatedValue        Decimal?  @db.Decimal(10, 2)
  actualValue           Decimal?  @db.Decimal(10, 2)
  leadScore             Int       @default(0)
  conversionStatus      String    @default("new") // new, contacted, qualified, proposal, won, lost
  conversionDate        DateTime?
  conversionValue       Decimal?  @db.Decimal(10, 2)
  timeToContactMinutes  Int?
  timeToConversionHours Int?
  touchpoints           Int       @default(0)
  marketingCampaign     String?
  referrerUrl           String?
  deviceType            String?   // desktop, mobile, tablet
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([leadId])
  @@index([conversionStatus])
  @@map("lead_analytics")
}

model LeadCampaignAttribution {
  id              String   @id @default(cuid())
  leadId          String
  campaignId      String
  attributionType String   @default("direct") // direct, assisted, last_touch, first_touch
  clickData       String?  // JSON: utm parameters, referrer data
  createdAt       DateTime @default(now())

  @@index([leadId])
  @@index([campaignId])
  @@map("lead_campaign_attribution")
}

model CustomerCommunication {
  id                String    @id @default(cuid())
  customerId        String
  leadId            String?
  projectId         String?
  communicationType String    // email, phone, text, meeting, site_visit
  direction         String    // inbound, outbound
  subject           String?
  content           String?
  channel           String?   // gmail, phone_system, sms_gateway, in_person
  fromContact       String?
  toContact         String?
  durationMinutes   Int?
  outcome           String?   // scheduled, info_gathered, proposal_sent
  followUpRequired  Boolean   @default(false)
  followUpDate      DateTime?
  attachments       String?   // JSON: file references
  metadata          String?   // JSON
  createdAt         DateTime  @default(now())

  @@index([customerId])
  @@index([projectId])
  @@map("customer_communications")
}

model MarketingCampaign {
  id               String    @id @default(cuid())
  campaignId       String    @unique
  name             String
  type             String    // google_ads, facebook, email, referral, direct_mail
  status           String    @default("active") // active, paused, completed, cancelled
  budget           Decimal?  @db.Decimal(10, 2)
  costPerLead      Decimal?  @db.Decimal(10, 2)
  targetCounties   String?   // JSON: array of target counties
  targetServices   String?   // JSON: array of target services
  startDate        DateTime?
  endDate          DateTime?
  leadsGenerated   Int       @default(0)
  conversions      Int       @default(0)
  revenueGenerated Decimal?  @db.Decimal(10, 2)
  roiPercentage    Decimal?  @db.Decimal(5, 2)
  metadata         String?   // JSON
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([status])
  @@index([type])
  @@map("marketing_campaigns")
}

model Notification {
  id             String    @id @default(cuid())
  notificationId String    @unique
  type           String    // lead_received, sop_due, project_update
  title          String
  message        String
  urgency        String    @default("medium") // low, medium, high, critical
  recipientType  String    // internal_team, customer, vendor
  recipientId    String?   // email, user_id, team_id
  channels       String?   // JSON: email, sms, push, webhook
  leadId         String?
  customerId     String?
  projectId      String?
  workflowId     String?
  metadata       String?   // JSON
  sentAt         DateTime?
  readAt         DateTime?
  acknowledgedAt DateTime?
  createdAt      DateTime  @default(now())

  @@index([type])
  @@index([recipientId])
  @@index([customerId])
  @@map("notifications")
}

// ============================================
// INFRASTRUCTURE MODELS
// ============================================

model IntegrationLog {
  id               String   @id @default(cuid())
  eventType        String   // customer_created, sop_triggered, team_assigned
  eventData        String   // JSON: complete event payload
  leadId           String?
  customerId       String?
  projectId        String?
  workflowId       String?
  success          Boolean  @default(true)
  errorMessage     String?
  processingTimeMs Int?
  timestamp        DateTime @default(now())

  @@index([eventType])
  @@index([timestamp])
  @@index([success])
  @@map("integration_logs")
}

model WorkflowTrigger {
  id            String   @id @default(cuid())
  triggerCode   String   @unique
  name          String
  description   String?
  triggerType   String   // lead_received, schedule, manual, event
  conditions    String?  // JSON: trigger conditions
  actions       String?  // JSON: actions to execute
  sopProcedures String?  // JSON: SOPs to initiate
  isActive      Boolean  @default(true)
  priority      Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([triggerType])
  @@index([isActive])
  @@map("workflow_triggers")
}

// ============================================
// NEW ENUMS FOR ADDED MODELS
// ============================================

enum SopStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  ACTIVE
  ARCHIVED
  DEPRECATED
}

enum SopPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum WorkflowStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
  FAILED
}
